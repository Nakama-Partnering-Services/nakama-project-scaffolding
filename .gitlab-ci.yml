image: salesforce/salesforcedx:latest-full

.sfdx-changes:
    - sfdx-source/frameworks/**/*
    - sfdx-source/**/main/**/*
    - sfdx-source/**/test/classes/**/*

.vlocity-changes:
    - sfdx-source/**/vlocity/**/*

.any-changes:
    - sfdx-source/frameworks/**/*
    - sfdx-source/**/main/**/*
    - sfdx-source/**/test/classes/**/*
    - sfdx-source/**/vlocity/**/*

workflow:
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
        - if: $DESTINATION_ENVIRONMENT != "" && ($METADATA_DEPLOYMENT == "true" || $VLOCITY_DEPLOYMENT == "true")
        - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
          when: never
        - if: $DEPLOY && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
          changes: !reference [.any-changes]
        - if: $VALIDATE_MERGE_REQUEST && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^release/)

include:
    - pipelines/.manual-deployment.yml
    - pipelines/.delta-operations.yml
    - pipelines/.code-quality.yml
    - pipelines/.push.yml
    - pipelines/.merge-request.yml
    - pipelines/.scheduled.yml

stages:
    - local-validations
    - generate-code_quality-report
    - generate-deltas
    - identify-test-classes
    - org-validations
    - delete-scratch-org
    - deploy-deltas-integration
    - deploy-vlocity-integration
    - backpromote-deltas
    - backpromote-vlocity
    - deploy-deltas-testing
    - deploy-vlocity-testing
    - scheduled-tests
    - scheduled-tests-report
    - manual-metadata-deployment
    - manual-vlocity-deployment
