image: salesforce/salesforcedx:latest-full

stages:
    - install-npm
    - create-package-version
    - install-package-in-devhub

install-npm-dependancies:
    stage: install-npm
    rules:
        - if: $CREATE_PACKAGE_VERSION_DISABLED
          when: never
        - changes:
              - frameworks/**/*
    script:
        - npm ci
    artifacts:
        paths:
            - node_modules

create-package-version:
    stage: create-package-version
    rules:
        - if: $CREATE_PACKAGE_VERSION_DISABLED
          when: never
        - changes:
              - frameworks/**/*
    script:
        - sfdx auth:sfdxurl:store --sfdxurlfile $DEVHUB_SFDX_AUTH_URL --setdefaultdevhubusername
        - json=$(sfdx force:package:version:create --package Frameworks --installationkeybypass --codecoverage --wait 30 --json)
        - versionId=$(echo $json | jq -r '.result.SubscriberPackageVersionId')
        # TODO: Persist sfdx-project.json and README.md
        - echo "versionId=$versionId" >> package.env
        - npx prettier --write sfdx-project.json README.md
        - git add sfdx-project.json README.md
        - git commit -m "Updated sfdx-project.json and README.md with new package version"
        - git push
    artifacts:
        reports:
            dotenv: package.env

install-package-in-devhub:
    stage: install-package-in-devhub
    rules:
        - if: $CREATE_PACKAGE_VERSION_DISABLED
          when: never
        - changes:
              - frameworks/**/*
    allow_failure: true
    environment:
        name: scratch/$CI_COMMIT_REF_SLUG
        url: $SCRATCH_ORG_URL
    resource_group: scratch/$CI_COMMIT_REF_SLUG
    script:
        - sfdx auth:sfdxurl:store --sfdxurlfile $DEVHUB_SFDX_AUTH_URL --setdefaultdevhubusername
        - sfdx force:org:create --definitionfile config/project-scratch-def.json --setdefaultusername --durationdays 1
        # Note: replace scratch org creation if scratch org pool is needed
        # - echo 'y' | sf plugins install sfpowerkit
        # - sf sfpowerkit pool fetch --tag base --setdefaultusername
        - SCRATCH_ORG_DETAILS=$(sfdx force:org:open --urlonly --json)
        - SCRATCH_ORG_URL=$(jq -r '.result.url' <<< $SCRATCH_ORG_DETAILS)
        - echo "SCRATCH_ORG_URL=$SCRATCH_ORG_URL" >> scratch.env
        - sfdx force:package:install --package $versionId --publishwait 10 --wait 10 --noprompt
    artifacts:
        reports:
            dotenv: scratch.env
