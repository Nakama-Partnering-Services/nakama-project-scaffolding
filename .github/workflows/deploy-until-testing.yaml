name: Deploy until Testing
on:
    push:
        branches: main
        paths:
            - sfdx-source/**

jobs:
    deploy-deltas:
        name: 'Deploy deltas'
        runs-on: ubuntu-latest
        strategy:
            matrix:
                destination: [DEVINT, TESTING, DEV1, DEV2, DEV3]
            max-parallel: 5
        steps:
            - name: 'Checkout source code'
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: 'Restore node_modules cache'
              id: cache-npm
              uses: actions/cache@v2
              with:
                  path: node_modules
                  key: npm-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      npm-${{ env.cache-name }}-
                      npm-

            - name: 'Install npm dependencies'
              if: steps.cache-npm.outputs.cache-hit != 'true'
              run: npm ci

            - name: Install Salesforce CLI
              run: npm install sfdx-cli --global

            - name: 'Create Destination auth file'
              env:
                  SFDX_AUTH_URL: ${{ matrix.destination }}_SFDX_AUTH_URL
              run: |
                  echo ${{ secrets[env.SFDX_AUTH_URL] }} > ./DESTINATION_SFDX_AUTH_URL.txt

            - name: 'Authorize Destination'
              run: sfdx auth:sfdxurl:store --sfdxurlfile ./DESTINATION_SFDX_AUTH_URL.txt --setalias 'Destination' --setdefaultusername

            - name: 'Remove Destination auth file'
              run: rm --force ./DESTINATION_SFDX_AUTH_URL.txt

            # Note: Tests do not run since it is redundant with PR and will take longer.
            - name: 'Get deltas and deploy'
              env:
                  LAST_DEPLOYMENT_COMMIT_SHA: ${{ matrix.destination }}_LAST_DEPLOYMENT_COMMIT_SHA
              run: |
                  echo 'y' | sfdx plugins:install sfdx-git-delta
                  mkdir deltas
                  sfdx sgd:source:delta --source sfdx-source --from ${{ secrets[env.LAST_DEPLOYMENT_COMMIT_SHA] }} --to HEAD --output deltas --ignore .forceignore --generate-delta
                  npm install fast-xml-parser
                  node scripts/node/environment-replacements/main.js
                  DESTINATION=$(echo ${{ matrix.destination }})
                  DESTINATION=${DESTINATION,,}
                  cp --recursive specific-environments/$DESTINATION/. sfdx-source/
                  sfdx force:source:deploy --manifest deltas/package/package.xml --postdestructivechanges deltas/destructiveChanges/destructiveChanges.xml --verbose

            - name: 'Update last deployment commit SHA'
              env:
                  LAST_DEPLOYMENT_COMMIT_SHA: ${{ matrix.destination }}_LAST_DEPLOYMENT_COMMIT_SHA
              uses: hmanzur/actions-set-secret@v2.0.0
              with:
                  name: ${{ env.LAST_DEPLOYMENT_COMMIT_SHA }}
                  value: ${{ github.sha }}
                  repository: ${{ github.repository }}
                  token: ${{ secrets.ACTIONS_ACCESS_TOKEN }}
