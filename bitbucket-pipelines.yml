image: salesforce/salesforcedx:latest-full

definitions:
    caches:
        custom-npm-cache: node_modules

pipelines:
    pull-requests:
        '{feature,bugfix,hotfix}/*': # Note: only work for source branches, not target branches.
            - step:
                  # caches: Note: this does not work as it is
                  #     - node
                  script:
                      - npm ci
                  artifacts:
                      - node_modules/**
            - parallel:
                  - step:
                        name: Verify formatting
                        script:
                            - CHANGED_FILES=$(git diff-tree --diff-filter=AM --no-commit-id --name-only -r origin/$BITBUCKET_PR_DESTINATION_BRANCH HEAD -- ':(exclude)**/reports/**' ':(exclude)**/email/**' ':(exclude)**/*.email-meta.xml' ':(exclude)**/experiences/**/*.json')
                            - IFS=$'\n'
                            - |
                                for FILE in $CHANGED_FILES;
                                do
                                    npx prettier --list-different "$FILE"
                                done
                            - unset IFS
                  - step:
                        name: Verify linting
                        script:
                            - CHANGED_FILES=$(git diff-tree --diff-filter=AM --no-commit-id --name-only -r origin/$BITBUCKET_PR_DESTINATION_BRANCH HEAD -- **/{aura,lwc}/**/*.js)
                            - IFS=$'\n'
                            - |
                                for FILE in $CHANGED_FILES;
                                do
                                    npx eslint "$FILE"
                                done
                            - unset IFS
                        condition:
                            changesets:
                                includePaths:
                                    - '**/aura/**'
                                    - '**/lwc/**'
                  - step:
                        name: Verify PMD
                        script:
                            - CHANGED_FILES=$(git diff-tree --diff-filter=AM --no-commit-id --name-only -r origin/$BITBUCKET_PR_DESTINATION_BRANCH HEAD)
                            - CHANGED_FILES=$(echo $CHANGED_FILES | tr -s '[:blank:]' ',')
                            - sfdx plugins:install @salesforce/sfdx-scanner
                            - sfdx scanner:run --pmdconfig config/pmd-ruleset.xml --target $CHANGED_FILES,!frameworks/**/*.cls --engine pmd --severity-threshold 3 --format table
                        condition:
                            changesets:
                                includePaths:
                                    - 'sfdx-source/**'
            - parallel:
                  - step:
                        name: Deltas validation deployment
                        # deployment: # CICD # UAT # PRODUCTION
                        script:
                            - DESTINATION_ENVIRONMENT=$(if [ "$BITBUCKET_PR_DESTINATION_BRANCH" = "main" ]; then echo "CICD"; elif [[ "$BITBUCKET_PR_DESTINATION_BRANCH" =~ ^rc/[0-9].[0-9].[0-9]$ ]]; then echo "UAT"; elif [[ "$BITBUCKET_PR_DESTINATION_BRANCH" =~ ^patch/[0-9].[0-9].[0-9]$ ]]; then echo "PRODUCTION"; fi)
                            - pull_request_response=$(curl -X GET -H "Authorization:Bearer $PIPELINE_ACCESS_TOKEN" --url https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_FULL_NAME/pullrequests/$BITBUCKET_PR_ID)
                            - echo $pull_request_response > pull_request.json
                            - description=$(jq '.description' pull_request.json)
                            - TESTS_SPECIFICATION=$(awk -F 'Tests:' '{print $2}' <<< "$description" | tr -d '"')
                            - TESTS_SPECIFICATION_ARRAY=($TESTS_SPECIFICATION)
                            - TEST_LEVEL=${TESTS_SPECIFICATION_ARRAY[0]}
                            - TEST_CLASSES=${TESTS_SPECIFICATION_ARRAY[1]}
                            - ./scripts/shell/pipelines/deploy.sh $DESTINATION_ENVIRONMENT origin/$BITBUCKET_PR_DESTINATION_BRANCH true $TEST_LEVEL $TEST_CLASSES
                        condition:
                            changesets:
                                includePaths:
                                    - 'sfdx-source/**'
                        artifacts:
                            - results.json
                        after-script:
                            - cat results.json
                  - step:
                        name: Scratch org validation
                        script:
                            - echo $DEVHUB_SFDX_AUTH_URL > ./DEVHUB_SFDX_AUTH_URL.txt
                            - sfdx auth:sfdxurl:store --sfdxurlfile ./DEVHUB_SFDX_AUTH_URL.txt --setdefaultdevhubusername
                            - sfdx force:org:create --definitionfile config/project-scratch-def.json --setdefaultusername --durationdays 1
                            # Note: replace scratch org creation if scratch org pool is needed
                            # - echo 'y' | sfdx plugins:install sfpowerkit
                            # - sfdx sfpowerkit:pool:fetch --tag base --setdefaultusername
                            - npm install fast-xml-parser
                            - node scripts/node/environment-replacements/main.js || true
                            - cp --recursive specific-environments/scratch-org/. sfdx-source/ || true
                            - sfdx force:source:push
                        condition:
                            changesets:
                                includePaths:
                                    - 'sfdx-source/**'
            - step:
                  name: Verify test coverage
                  script:
                      - NON_TEST_CLASSES=$((egrep -wrliL '@IsTest|public interface' deltas --include \*.cls || echo "") | xargs -rL 1 basename | sed 's/.cls//g' | paste -sd "," -)
                      - |
                          if [ $NON_TEST_CLASSES ]; then
                              sfdx nps:coverage:verify --path results.json --required-coverage 90 --classes $NON_TEST_CLASSES
                          fi
                  condition:
                      changesets:
                          includePaths:
                              - 'sfdx-source/**'
    branches:
        main:
            - parallel:
                  - step:
                        name: Deploy CICD
                        deployment: CICD
                        script:
                            - ./scripts/shell/pipelines/deploy.sh CICD $CICD_LAST_DEPLOYMENT_COMMIT_SHA False NoTestRun
                            - curl -X PUT -H "Authorization:Bearer $PIPELINE_ACCESS_TOKEN" --url https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_FULL_NAME/pipelines_config/variables/%7BCICD_LAST_DEPLOYMENT_COMMIT_SHA_UUID%7D -H 'Content-Type:application/json' -d "{\"key\":\"CICD_LAST_DEPLOYMENT_COMMIT_SHA\", \"value\":\"$BITBUCKET_COMMIT\"}"
                        condition:
                            changesets:
                                includePaths:
                                    - 'sfdx-source/**'
                  # TODO: add QA and lower environments

        rc/*:
            - step:
                  name: Deploy UAT
                  deployment: UAT
                  script:
                      - ./scripts/shell/pipelines/deploy.sh UAT $UAT_LAST_DEPLOYMENT_COMMIT_SHA False NoTestRun
                      - curl -X PUT -H "Authorization:Bearer $PIPELINE_ACCESS_TOKEN" --url https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_FULL_NAME/pipelines_config/variables/%7B$UAT_LAST_DEPLOYMENT_COMMIT_SHA_UUID%7D -H 'Content-Type:application/json' -d "{\"key\":\"UAT_LAST_DEPLOYMENT_COMMIT_SHA\", \"value\":\"$BITBUCKET_COMMIT\"}"
                  condition:
                      changesets:
                          includePaths:
                              - 'sfdx-source/**'
    custom:
        scheduled-validation-deployments:
            - parallel:
                  - step:
                        name: Daily validation deployment with tests
                        deployment: CICD
                        script:
                            - ./scripts/shell/pipelines/validation-with-tests.sh CICD
                  # TODO: add QA, UAT, PRODUCTION and HOTFIX environments
        manual-deployment:
            - variables:
                  - name: DESTINATION_ENVIRONMENT
                    allowed-values:
                        - 'CICD'
                        - 'QA'
                        - 'UAT'
                        - 'PRODUCTION'
                    default: 'CICD'
                  - name: checkonly
                  - name: testlevel
                    allowed-values:
                        - 'NoTestRun'
                        - 'RunSpecifiedTests'
                        - 'RunLocalTests'
                        - 'RunAllTestsInOrg'
                    default: 'RunLocalTests'
                  - name: runtests
            - step:
                  name: Deploy
                  script:
                      - LAST_DEPLOYMENT_COMMIT_SHA=$(eval echo \${${DESTINATION_ENVIRONMENT}_LAST_DEPLOYMENT_COMMIT_SHA})
                      - ./scripts/shell/pipelines/deploy.sh $DESTINATION_ENVIRONMENT $LAST_DEPLOYMENT_COMMIT_SHA $checkonly $testlevel $runtests
            - step:
                  name: Update LAST_DEPLOYMENT_COMMIT_SHA
                  script:
                      - |
                          if [ ! $VALIDATION_PARAMETER ]; then
                              TARGET_VARIABLE_ID=$(eval echo \${${DESTINATION_ENVIRONMENT}_LAST_DEPLOYMENT_COMMIT_SHA_UUID})
                              TARGET_VARIABLE="${DESTINATION_ENVIRONMENT}_LAST_DEPLOYMENT_COMMIT_SHA"
                              curl -X PUT -H "Authorization:Bearer $PIPELINE_ACCESS_TOKEN" --url https://api.bitbucket.org/2.0/repositories/$BITBUCKET_REPO_FULL_NAME/pipelines_config/variables/%7B$TARGET_VARIABLE_ID%7D -H 'Content-Type:application/json' -d "{\"key\":\"$TARGET_VARIABLE\", \"value\":\"$BITBUCKET_COMMIT\"}"
                          fi
