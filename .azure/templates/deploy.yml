parameters:
    - name: VALIDATION
      type: boolean
    - name: RUN_TEST_PARAMETER
      type: string
    - name: DESTINATION_ENVIRONMENT
      type: string

steps:
    - script: |
          echo "sfdx plugins"
          sfdx plugins
          DESTINATION_ENVIRONMENT=${{ parameters.DESTINATION_ENVIRONMENT }}
          LAST_DEPLOYMENT_COMMIT_SHA=$(eval echo \${${DESTINATION_ENVIRONMENT}_LAST_DEPLOYMENT_COMMIT_SHA})
          source .env.replacements # TODO: test if it works properly
          bash /deploy.sh $DESTINATION_ENVIRONMENT $LAST_DEPLOYMENT_COMMIT_SHA ${{ parameters.VALIDATION }} ${{ parameters.RUN_TEST_PARAMETER }}
      # Secret variables need to be declared here to be mapped
      env:
          NAKAMA_ACCESS_TOKEN: $(NAKAMA_ACCESS_TOKEN)
          CICD_SFDX_AUTH_URL: $(CICD_SFDX_AUTH_URL)
          # QA_SFDX_AUTH_URL: $(QA_SFDX_AUTH_URL)
          # UAT_SFDX_AUTH_URL: $(QA_SFDX_AUTH_URL)
          # TODO: add lower environments

    - ${{ if eq(parameters.VALIDATION, false) }}:
          - template: save-deployment-commit.yml
            parameters:
                DESTINATION_ENVIRONMENT: ${{ parameters.DESTINATION_ENVIRONMENT }}
