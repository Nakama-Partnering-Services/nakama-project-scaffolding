parameters:
    - name: VALIDATION
      type: boolean
    - name: RUN_TEST_PARAMETER
      type: string
    - name: DESTINATION_ENVIRONMENT
      type: string

steps:
    - script: |
          DESTINATION_ENVIRONMENT=${{ parameters.DESTINATION_ENVIRONMENT }}
          LAST_DEPLOYMENT_COMMIT_SHA=$(eval echo \${${DESTINATION_ENVIRONMENT}_LAST_DEPLOYMENT_COMMIT_SHA})
          source .env.replacements # TODO: test if it works properly
          curl -s https://raw.githubusercontent.com/Nakama-Partnering-Services/nakama-project-scaffolding/main/scripts/shell/pipelines/deploy.sh > ./deploy.sh
          chmod +x ./deploy.sh
          ./deploy.sh $DESTINATION_ENVIRONMENT $LAST_DEPLOYMENT_COMMIT_SHA ${{ parameters.VALIDATION }} ${{ parameters.RUN_TEST_PARAMETER }}
      # Secret variables need to be declared here to be mapped
      env:
          CICD_SFDX_AUTH_URL: $(CICD_SFDX_AUTH_URL)
          # QA_SFDX_AUTH_URL: $(QA_SFDX_AUTH_URL)
          # UAT_SFDX_AUTH_URL: $(QA_SFDX_AUTH_URL)
          # TODO: add lower environments

    - ${{ if eq(parameters.VALIDATION, false) }}:
          - template: save-deployment-commit.yml
            parameters:
                DESTINATION_ENVIRONMENT: ${{ parameters.DESTINATION_ENVIRONMENT }}
